pipeline {
    agent any
    
    environment {
        HARBOR_URL = '10.10.80.77:30280'
        HARBOR_PROJECT = 'library'
        APP_NAME = 'sample-cicd-app'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        GITOPS_REPO = 'https://github.com/YOUR-USERNAME/gitops-repo.git'
        DOCKER_IMAGE = "${HARBOR_URL}/${HARBOR_PROJECT}/${APP_NAME}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out source code...'
                checkout scm
                sh 'ls -la'
            }
        }
        
        stage('Test') {
            steps {
                echo 'ğŸ§ª Running tests...'
                sh '''
                    npm install
                    npm test
                '''
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo "ğŸ³ Building Docker image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                script {
                    dockerImage = docker.build("${DOCKER_IMAGE}:${IMAGE_TAG}")
                    // Also tag as latest
                    sh "docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest"
                }
            }
        }
        
        stage('Push to Harbor') {
            steps {
                echo 'ğŸ“¤ Pushing image to Harbor registry...'
                script {
                    docker.withRegistry("http://${HARBOR_URL}", 'harbor-credentials') {
                        dockerImage.push("${IMAGE_TAG}")
                        dockerImage.push('latest')
                    }
                }
                echo "âœ… Image pushed: ${DOCKER_IMAGE}:${IMAGE_TAG}"
            }
        }
        
        stage('Update GitOps Repository') {
            steps {
                echo 'ğŸ“ Updating Kubernetes manifests in GitOps repository...'
                withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                        # Configure git
                        git config --global user.email "jenkins@cicd.local"
                        git config --global user.name "Jenkins CI"
                        
                        # Clone GitOps repository
                        rm -rf gitops-repo
                        git clone https://${GITHUB_TOKEN}@github.com/YOUR-USERNAME/gitops-repo.git
                        cd gitops-repo
                        
                        # Update image tag in deployment manifest
                        sed -i "s|image: ${HARBOR_URL}/${HARBOR_PROJECT}/${APP_NAME}:.*|image: ${HARBOR_URL}/${HARBOR_PROJECT}/${APP_NAME}:${IMAGE_TAG}|" ${APP_NAME}/deployment.yaml
                        
                        # Update version annotation
                        sed -i "s|version: .*|version: \\"${IMAGE_TAG}\\"|" ${APP_NAME}/deployment.yaml
                        
                        # Commit and push changes
                        git add ${APP_NAME}/deployment.yaml
                        git commit -m "ğŸš€ Deploy ${APP_NAME} version ${IMAGE_TAG} [ci skip]"
                        git push origin main
                        
                        echo "âœ… GitOps repository updated"
                    '''
                }
            }
        }
        
        stage('Notify ArgoCD') {
            steps {
                echo 'ğŸ”„ ArgoCD will automatically detect changes and deploy...'
                script {
                    // Optional: Force ArgoCD sync via API or CLI
                    sh '''
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "âœ… Pipeline completed successfully!"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "ğŸ“¦ Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                        echo "ğŸª Registry: Harbor at ${HARBOR_URL}"
                        echo "ğŸ“ GitOps: Repository updated"
                        echo "ğŸš€ ArgoCD: Will deploy automatically"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âœ… BUILD SUCCESSFUL!'
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo "Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
            echo "View in Harbor: http://${HARBOR_URL}"
            echo "View in ArgoCD: http://10.10.80.77:30443"
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
        }
        failure {
            echo 'âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âŒ BUILD FAILED!'
            echo 'âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'Check logs for details'
        }
        always {
            echo 'ğŸ§¹ Cleaning up...'
            sh '''
                # Clean up Docker images to save space
                docker rmi ${DOCKER_IMAGE}:${IMAGE_TAG} || true
                docker rmi ${DOCKER_IMAGE}:latest || true
                docker system prune -f || true
                
                # Clean up gitops repo clone
                rm -rf gitops-repo
            '''
        }
    }
}
