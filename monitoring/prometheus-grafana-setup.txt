# PROMETHEUS AND GRAFANA MONITORING SETUP
# For Kubernetes Cluster with Rancher
# Date: November 4, 2025

===========================================
MONITORING STACK OVERVIEW
===========================================

COMPONENTS TO INSTALL:
- Prometheus Operator (via kube-prometheus-stack)
- Grafana Dashboard
- AlertManager
- Node Exporter
- Kube State Metrics
- ServiceMonitor for cluster monitoring

NAMESPACE: monitoring

===========================================
SECTION 1: INSTALL MONITORING STACK
===========================================

1.1 ADD PROMETHEUS COMMUNITY HELM REPOSITORY
Run on Master (10.10.80.76):

# Add Prometheus community repository
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

1.2 CREATE MONITORING NAMESPACE
kubectl create namespace monitoring

1.3 INSTALL KUBE-PROMETHEUS-STACK
Run on Master (10.10.80.76):

# Install complete monitoring stack
helm install prometheus-stack prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
  --set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false \
  --set prometheus.prometheusSpec.ruleSelectorNilUsesHelmValues=false \
  --set prometheus.prometheusSpec.retention=30d \
  --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=20Gi \
  --set alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.resources.requests.storage=5Gi \
  --set grafana.adminPassword=admin123 \
  --set grafana.service.type=NodePort \
  --set grafana.service.nodePort=31000 \
  --set prometheus.service.type=NodePort \
  --set prometheus.service.nodePort=31001 \
  --set alertmanager.service.type=NodePort \
  --set alertmanager.service.nodePort=31002

# Wait for deployment to complete
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=grafana -n monitoring --timeout=600s
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n monitoring --timeout=600s

1.4 VERIFY INSTALLATION
# Check all monitoring pods
kubectl get pods -n monitoring

# Check services
kubectl get svc -n monitoring

# Check persistent volumes
kubectl get pv
kubectl get pvc -n monitoring

===========================================
SECTION 2: ACCESS MONITORING SERVICES
===========================================

2.1 GRAFANA ACCESS
URL: http://10.10.80.76:31000
Username: admin
Password: admin123

# Alternative: Get Grafana NodePort if different
kubectl get svc prometheus-stack-grafana -n monitoring

2.2 PROMETHEUS ACCESS
URL: http://10.10.80.76:31001
No authentication required

# Alternative: Get Prometheus NodePort if different
kubectl get svc prometheus-stack-kube-prom-prometheus -n monitoring

2.3 ALERTMANAGER ACCESS
URL: http://10.10.80.76:31002
No authentication required

# Alternative: Get AlertManager NodePort if different
kubectl get svc prometheus-stack-kube-prom-alertmanager -n monitoring

===========================================
SECTION 3: CONFIGURE GRAFANA DASHBOARDS
===========================================

3.1 IMPORT PRE-CONFIGURED DASHBOARDS
Grafana comes with several pre-configured dashboards for Kubernetes monitoring:

1. Login to Grafana at http://10.10.80.76:31000
2. Go to "Dashboards" → "Browse"
3. You'll find pre-installed dashboards:
   - Kubernetes / Compute Resources / Cluster
   - Kubernetes / Compute Resources / Namespace (Pods)
   - Kubernetes / Compute Resources / Node (Pods)
   - Node Exporter / Nodes

3.2 IMPORT ADDITIONAL DASHBOARDS
Popular Kubernetes Dashboard IDs from grafana.com:
- 315: Kubernetes cluster monitoring
- 8588: Kubernetes Deployment Statefulset Daemonset metrics
- 6417: Kubernetes cluster autoscaler
- 7249: Kubernetes cluster

To import:
1. Go to "+" → "Import"
2. Enter dashboard ID
3. Select Prometheus as data source
4. Import

===========================================
SECTION 4: CONFIGURE ALERTS
===========================================

4.1 BASIC ALERTING RULES
The kube-prometheus-stack comes with pre-configured alerts. View them:

# Check PrometheusRules
kubectl get prometheusrule -n monitoring

# View specific rule details
kubectl describe prometheusrule prometheus-stack-kube-prom-kubernetes-apps -n monitoring

4.2 CONFIGURE ALERTMANAGER
Create custom AlertManager configuration:

cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-prometheus-stack-kube-prom-alertmanager
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
    receivers:
    - name: 'web.hook'
      webhook_configs:
      - url: 'http://127.0.0.1:5001/'
        send_resolved: true
EOF

===========================================
SECTION 5: CUSTOM MONITORING
===========================================

5.1 MONITOR CUSTOM APPLICATIONS
Create a ServiceMonitor for custom applications:

cat <<EOF | kubectl apply -f -
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: my-app-monitor
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: my-app
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
EOF

5.2 CREATE CUSTOM DASHBOARD
1. In Grafana, go to "+" → "Dashboard"
2. Add panels with PromQL queries
3. Example queries:
   - CPU Usage: `rate(cpu_usage_seconds_total[5m])`
   - Memory Usage: `container_memory_usage_bytes`
   - Pod Count: `kube_pod_info`

===========================================
SECTION 6: INGRESS FOR MONITORING SERVICES
===========================================

6.1 CREATE INGRESS FOR GRAFANA
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: grafana.local.cluster
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-stack-grafana
            port:
              number: 80
EOF

6.2 CREATE INGRESS FOR PROMETHEUS
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-ingress
  namespace: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: prometheus.local.cluster
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-stack-kube-prom-prometheus
            port:
              number: 9090
EOF

6.3 UPDATE HOSTS FILE
Add to /etc/hosts on your local machine:
10.10.80.76 grafana.local.cluster
10.10.80.76 prometheus.local.cluster

Access via:
- Grafana: https://grafana.local.cluster:32085
- Prometheus: https://prometheus.local.cluster:32085

===========================================
SECTION 7: MAINTENANCE AND TROUBLESHOOTING
===========================================

7.1 USEFUL MONITORING COMMANDS
# Check monitoring stack status
kubectl get all -n monitoring

# View Grafana logs
kubectl logs -n monitoring -l app.kubernetes.io/name=grafana

# View Prometheus logs
kubectl logs -n monitoring -l app.kubernetes.io/name=prometheus

# Check Prometheus targets
kubectl port-forward -n monitoring svc/prometheus-stack-kube-prom-prometheus 9090:9090
# Then visit http://localhost:9090/targets

7.2 BACKUP GRAFANA DASHBOARDS
# Get Grafana database
kubectl exec -n monitoring -it $(kubectl get pod -n monitoring -l app.kubernetes.io/name=grafana -o name | head -1) -- sqlite3 /var/lib/grafana/grafana.db ".backup /tmp/grafana.db"

# Copy backup
kubectl cp monitoring/$(kubectl get pod -n monitoring -l app.kubernetes.io/name=grafana -o jsonpath='{.items[0].metadata.name}'):/tmp/grafana.db ./grafana-backup.db

7.3 UPGRADE MONITORING STACK
# Upgrade to latest version
helm repo update
helm upgrade prometheus-stack prometheus-community/kube-prometheus-stack -n monitoring

===========================================
ACCESS SUMMARY
===========================================

MONITORING SERVICES ACCESS:
✅ Grafana: http://10.10.80.76:31000 (admin/admin123)
✅ Prometheus: http://10.10.80.76:31001
✅ AlertManager: http://10.10.80.76:31002

INGRESS ACCESS (if configured):
✅ Grafana: https://grafana.local.cluster:32085
✅ Prometheus: https://prometheus.local.cluster:32085

FEATURES INCLUDED:
✓ Complete Prometheus monitoring
✓ Grafana dashboards with pre-configured views
✓ AlertManager for notifications
✓ Node Exporter for system metrics
✓ Kube State Metrics for Kubernetes objects
✓ Persistent storage for metrics retention

===========================================
END OF MONITORING SETUP GUIDE
===========================================